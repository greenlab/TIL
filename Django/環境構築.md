2025/08/03

# Django

## 環境構築

Django＋Postgresql という構成で環境構築を行う。

設定先OS：Ubuntu 24.04

### 準備

1. Python インストール  
```
// Python 3.8 以上をインストールする。  
$ python3 --version
Python 3.12.3

// 仮想環境を作成する。
$ python3 -m venv --system-site-packages ~/django5
The virtual environment was not created successfully because ensurepip is not
available.  On Debian/Ubuntu systems, you need to install the python3-venv
package using the following command.

    apt install python3.12-venv

You may need to use sudo with that command.  After installing the python3-venv
package, recreate your virtual environment.

Failing command: /home/mi/django5/bin/python3

// 仮想環境のパッケージがインストールされていなかった。
$ sudo apt install -y python3.12-venv

// 再チャレンジ
$ python3 -m venv --system-site-packages ~/django5

// 仮想環境に入る
$ source ~/django5/bin/activate

// Django と、PostgreSQL ドライバのインストール
$ pip install django psycopg2-binary

// 仮想環境から出る
$ deactivate
```

Pythonで、仮想環境ってどういうことかなと思ったが、Pythonのバージョンも含めて、独立した環境を作るということのようで。  
venv って、Virtual Enviroment かな。  

参考：https://python-engineer.co.jp/what-venv/

2. PostgreSQL のセットアップ。

```
// PostgreSQL をインストールする。
$ sudo apt-get install postgresql

// データベースに接続
$ sudo -u postgres psql
// データベース作成
# CREATE DATABASE myapp_django_1st;
// PostgreSQL より離脱
# exit;
```

### Django プロジェクトの作成

1. プロジェクト初期化
```
// 仮想環境に入る
$ source ~/django5/bin/activate
// プロジェクト初期化
$ django-admin startproject myproject
$ cd myproject
```

2. データベース設定
```
$ nano ./myproject/settings.py
```

```
# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}
```
  ↓↓↓↓
```
# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'myapp_django_1st',
        'USER': 'postgres',
        'PASSWORD': 'yourpassword',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
```

3. アプリ作成とモデル定義

新しいアプリを作成
```
$ python manage.py startapp myapp_django_1st
```

myapp/models.pyにモデルを定義（例: シンプルなブログ投稿モデル）
```
$ nano ./myapp/models.py
```

```
from django.db import models

class Post(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.title
```

4. マイグレーション（失敗）

モデルをデータベースに反映
```
$ python manage.py makemigrations
(home)/django5/lib/python3.12/site-packages/django/core/management/commands/makemigrations.py:161: RuntimeWarning: Got an error checking a consistent migration history performed for database connection 'default': connection to server at "localhost" (127.0.0.1), port 5432 failed: FATAL:  password authentication failed for user "postgres"
connection to server at "localhost" (127.0.0.1), port 5432 failed: FATAL:  password authentication failed for user "postgres"

  warnings.warn(
No changes detected
// PostgreSQLへの接続エラー
```

PostgreSQLに、パスワードを設定する。  
ついでに、DBへの接続設定は .env 経由にする。

5. データベース設定（再）

データベースのユーザーにパスワード設定
```
// データベースに接続
$ sudo -u postgres psql
// パスワード設定
\password postgres
```

PostgreSQL の認証設定変更
```
$ sudo nano /etc/postgresql/16/main/pg_hba.conf
```

```
# Database administrative login by Unix domain socket
local   all             postgres                                peer
```
  ↓↓↓↓
```
# Database administrative login by Unix domain socket
local   all             postgres                                scram-sha-256
```

```
// データベース再起動
$ sudo systemctl restart postgresql
// パスワードが有効になったか接続試験
$ psql -U postgres -h localhost -d myapp_django_1st
Password for user postgres:
// OK!
```

データベース設定変更
```
$ nano ./myproject/settings.py
```

```
// 先頭
from pathlib import Path
from decouple import config

// Database設定
# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': config('DB_NAME'),
        'USER': config('DB_USER'),
        'PASSWORD': config('DB_PASSWORD'),
        'HOST': config('DB_HOST'),
        'PORT': config('DB_PORT'),
    }
}
```

.env ファイルをプロジェクトルード上に作成
```
$ nano ~/myproject/.env
```

```
DB_NAME=myapp_django_1st
DB_USER=postgres
DB_PASSWORD=(password)
DB_HOST=localhost
DB_PORT=5432
```

python-decouple をインストール  

Djangoで、.env を簡単に読み込むためのライブラリとのこと
```
$ pip install python-decouple
```

依存関係を保存
```
$ pip freeze > requirements.txt
```

6. マイグレーション
モデルをデータベースに反映
```
$ python manage.py makemigrations
$ python manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying auth.0012_alter_user_first_name_max_length... OK
  Applying sessions.0001_initial... OK
// OK!
```

Django上からデータベースへの接続確認
```
$ python manage.py dbshell
psql (16.9 (Ubuntu 16.9-0ubuntu0.24.04.1))
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off)
Type "help" for help.

// OK!
```

## ビューとテンプレート

myapp/views.py にビューを追加する。
```
from django.shortcuts import render
from .models import Post

def post_list(request):
    posts = Post.objects.all()
    return render(request, 'myapp/post_list.html', {'posts': posts})
```

myapp/templates/myapp/post_list.html を作成する。
```
$ mkdir myapp/templates
$ mkdir myapp/templates/myapp
$ nano ./myapp/templates/myapp/post_list.html
```

```
<!DOCTYPE html>
<html>
<body>
    <h1>Posts</h1>
    <ul>
        {% for post in posts %}
            <li>{{ post.title }} - {{ post.created_at }}</li>
        {% endfor %}
    </ul>
</body>
</html>
```

## URL設定

myproject/urls.py にルーティングを追加する。
```
$ nano ./urls.py 
```
```
from django.urls import path
from myapp.views import post_list

urlpatterns = [
    path('posts/', post_list, name='post_list'),
]
```

## サーバー起動

```
$ python manage.py runserver
```

